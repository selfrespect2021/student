<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØªØ§Ø¦Ø¬ Ù…Ø¯Ø±Ø³Ø© Ø·Ù‡ Ø­Ø³ÙŠÙ† - Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù„ÙƒØ§Ù†ÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --success: #27ae60; --bg: #f4f7f6; --error: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: white; max-width: 800px; margin: 10px auto; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .header { border-bottom: 3px solid var(--accent); margin-bottom: 20px; padding-bottom: 10px; }
        input[type="text"] { padding: 15px; width: 80%; border: 2px solid #ddd; border-radius: 12px; font-size: 1.2em; text-align: center; margin-bottom: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 15px 25px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 85%; font-size: 1.1em; transition: 0.3s; margin: 5px 0; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border: 2px solid var(--primary); }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .result-table th { background: var(--primary); color: white; }
        .student-name { color: #e67e22; font-size: 1.6em; font-weight: bold; margin: 10px 0; padding: 10px; background: #fff8f0; border-radius: 10px; border: 1px solid #ffe0b2; }
        .avg-row { background: #fff3cd; font-weight: bold; }
        .admin-panel { margin-top: 30px; padding: 15px; border: 2px dashed #ccc; border-radius: 15px; background: #fdfdfd; }
        #updateStatus { margin: 10px 0; font-weight: bold; padding: 8px; border-radius: 5px; }
        .error-msg { color: var(--error); padding: 15px; background: #fdedec; border-radius: 10px; margin-top: 10px; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h2>
        <p>Ù…Ø¯Ø±Ø³Ø© Ø·Ù‡ Ø­Ø³ÙŠÙ† | Ø§Ù„Ø£Ø³ØªØ§Ø°: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ Ø¨Ù„ÙƒØ§Ù†ÙŠ</p>
    </div>

    <input type="text" id="massarID" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ù…Ø«Ù„Ø§Ù‹: G123456789)">
    <button onclick="displayResult()">ğŸ” Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø·</button>

    <div id="output"></div>

    <div class="admin-panel">
        <h3 style="color: var(--error);">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù)</h3>
        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
        <div id="updateStatus"></div>
    </div>
</div>

<script>
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†
    var MAIN_DATA = {};

    const DESC_MAP = {
        "PO2": "Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø´ÙÙ‡ÙŠ", "V1": "Ø§Ù„Ù…Ø¹Ø¬Ù… 1", "V2": "Ø§Ù„Ù…Ø¹Ø¬Ù… 2", "CO1": "ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ 1", "CO2": "ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ 2",
        "LF2": "Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©", "LC1": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 1", "LC2": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 2", "LC3": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 3", "LC4": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 4",
        "PE1": "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ 1", "PE2": "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ 2", "OL1": "Ø§Ù„Ø¸ÙˆØ§Ù‡Ø± Ø§Ù„Ù„ØºÙˆÙŠØ© 1", "OL2": "Ø§Ù„Ø¸ÙˆØ§Ù‡Ø± Ø§Ù„Ù„ØºÙˆÙŠØ© 2",
        "HIST": "Ø§Ù„ØªØ§Ø±ÙŠØ®", "GEO": "Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©", "CIV": "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", "ISLAM": "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©"
    };

    const LABELS = Object.keys(DESC_MAP);

    function displayResult() {
        var input = document.getElementById('massarID').value;
        var id = input.trim().toUpperCase();
        var out = document.getElementById('output');
        
        console.log("Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†:", id); // Ù„Ù„ØªØ£ÙƒØ¯ ÙÙŠ Console
        
        if (!id) {
            out.innerHTML = '<div class="error-msg">âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹</div>';
            return;
        }

        var student = MAIN_DATA[id];
        
        if (!student) {
            out.innerHTML = '<div class="error-msg">âŒ Ø§Ù„Ø±Ù‚Ù… (' + id + ') ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªÙ… Ø±ÙØ¹Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
            return;
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
        var html = '<div class="student-name">' + student.name + '</div>';
        html += '<div style="margin-bottom:10px;">Ø§Ù„Ù‚Ø³Ù…: <strong>' + student.classRoom + '</strong></div>';
        
        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        html += '<h3>ğŸ“š ÙˆØ­Ø¯Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h3>';
        html += '<table class="result-table"><thead><tr><th>Ø§Ù„Ù…ÙƒÙˆÙ†</th><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th></tr></thead><tbody>';
        for (var i = 0; i < 14; i++) {
            html += '<tr><td>' + DESC_MAP[LABELS[i]] + '</td><td>' + (student.grades[i] || 0) + '</td></tr>';
        }
        html += '<tr class="avg-row"><td>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</td><td>' + student.avg + '</td></tr></tbody></table>';

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª
        var s1 = parseFloat(student.grades[14]) || 0;
        var s2 = parseFloat(student.grades[15]) || 0;
        var s3 = parseFloat(student.grades[16]) || 0;
        var socAvg = ((s1 + s2 + s3) / 3).toFixed(2);
        
        html += '<h3>ğŸŒ ÙˆØ­Ø¯Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</h3>';
        html += '<table class="result-table"><tr><td>Ø§Ù„ØªØ§Ø±ÙŠØ®</td><td>'+s1+'</td></tr><tr><td>Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§</td><td>'+s2+'</td></tr><tr><td>Ø§Ù„Ù…Ø¯Ù†ÙŠØ©</td><td>'+s3+'</td></tr><tr class="avg-row"><td>Ø§Ù„Ù…Ø¹Ø¯Ù„</td><td>'+socAvg+'</td></tr></table>';

        // Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
        html += '<h3>ğŸ•Œ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</h3>';
        html += '<table class="result-table"><tr><td>Ø§Ù„Ù†Ù‚Ø·Ø©</td><td>' + (student.grades[17] || 0) + '</td></tr></table>';

        out.innerHTML = html;
        console.log("ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­!");
    }

    function handleFileUpload(event) {
        var file = event.target.files[0];
        var status = document.getElementById('updateStatus');
        if (!file) return;

        status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
        status.style.color = "blue";

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, {type: 'array'});
                var sheetName = workbook.SheetNames[0];
                var sheet = workbook.Sheets[sheetName];
                var json = XLSX.utils.sheet_to_json(sheet, {header: 1});

                MAIN_DATA = {}; // ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©

                for (var i = 1; i < json.length; i++) {
                    var row = json[i];
                    if (!row || !row[0]) continue;

                    // ØªÙ†Ø¸ÙŠÙ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø« (Ø±Ù‚Ù… Ù…Ø³Ø§Ø±) Ù…Ù† Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ù…Ø®ÙÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹
                    var cleanID = String(row[0]).replace(/\s+/g, '').toUpperCase();
                    
                    var g = [];
                    for (var j = 3; j < 21; j++) {
                        var val = parseFloat(row[j]);
                        g.push(isNaN(val) ? 0 : val);
                    }

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„
                    var sum = 0;
                    for(var k=0; k<14; k++) sum += g[k];
                    var average = (sum / 14).toFixed(2);

                    MAIN_DATA[cleanID] = {
                        name: row[1] || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
                        classRoom: row[2] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                        grades: g,
                        avg: average
                    };
                }

                var count = Object.keys(MAIN_DATA).length;
                status.innerHTML = "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„! " + count + " ØªÙ„Ù…ÙŠØ° Ø¬Ø§Ù‡Ø²ÙˆÙ† Ù„Ù„Ø¹Ø±Ø¶.";
                status.style.color = "green";
                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", MAIN_DATA);

            } catch (err) {
                status.innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message;
                status.style.color = "red";
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
