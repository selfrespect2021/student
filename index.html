<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØªØ§Ø¦Ø¬ Ù…Ø¯Ø±Ø³Ø© Ø·Ù‡ Ø­Ø³ÙŠÙ† - Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù„ÙƒØ§Ù†ÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --success: #27ae60; --bg: #f4f7f6; --error: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: white; max-width: 800px; margin: 20px auto; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .header { border-bottom: 3px solid var(--accent); margin-bottom: 20px; padding-bottom: 10px; }
        input[type="text"] { padding: 15px; width: 85%; border: 2px solid #ddd; border-radius: 12px; font-size: 1.2em; text-align: center; margin-bottom: 15px; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 15px 30px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 90%; font-size: 1.1em; transition: 0.3s; }
        button:hover { background: #1f5f8b; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        .result-table th, .result-table td { border: 1px solid #eee; padding: 10px; text-align: center; }
        .result-table th { background: var(--primary); color: white; font-size: 0.9em; }
        .student-name { color: #e67e22; font-size: 1.7em; font-weight: bold; margin: 15px 0; padding: 10px; background: #fff8f0; border-radius: 10px; }
        .avg-row { background: #fff3cd; font-weight: bold; font-size: 1.1em; }
        .admin-panel { margin-top: 30px; padding: 20px; border: 2px dashed #ccc; border-radius: 15px; background: #fafafa; }
        #updateStatus { margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        .error-msg { color: var(--error); padding: 15px; background: #fdedec; border-radius: 10px; margin-top: 15px; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h2>
        <p>Ù…Ø¯Ø±Ø³Ø© Ø·Ù‡ Ø­Ø³ÙŠÙ† | Ø§Ù„Ø£Ø³ØªØ§Ø°: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ Ø¨Ù„ÙƒØ§Ù†ÙŠ</p>
    </div>

    <input type="text" id="massarID" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø³Ø§Ø± (G...)">
    <button onclick="displayResult()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</button>

    <div id="output"></div>

    <div class="admin-panel">
        <h3 style="color: var(--error);">âš™ï¸ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
        <button style="background: var(--success);" onclick="document.getElementById('excelFile').click()">
            ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø§Ù„Ø¬Ø¯ÙŠØ¯
        </button>
        <div id="updateStatus"></div>
    </div>
</div>

<script>
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§Ø¦Ù† Ø¹Ø§Ù„Ù…ÙŠ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.localDB = {};

    const labels = ["PO2", "V1", "V2", "CO1", "CO2", "LF2", "LC1", "LC2", "LC3", "LC4", "PE1", "PE2", "OL1", "OL2", "HIST", "GEO", "CIV", "ISLAM"];
    const desc = {
        "PO2": "Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø´ÙÙ‡ÙŠ", "V1": "Ø§Ù„Ù…Ø¹Ø¬Ù… 1", "V2": "Ø§Ù„Ù…Ø¹Ø¬Ù… 2", "CO1": "ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ 1", "CO2": "ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ 2",
        "LF2": "Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©", "LC1": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 1", "LC2": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 2", "LC3": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 3", "LC4": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 4",
        "PE1": "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ 1", "PE2": "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ 2", "OL1": "Ø§Ù„Ø¸ÙˆØ§Ù‡Ø± Ø§Ù„Ù„ØºÙˆÙŠØ© 1", "OL2": "Ø§Ù„Ø¸ÙˆØ§Ù‡Ø± Ø§Ù„Ù„ØºÙˆÙŠØ© 2",
        "HIST": "Ø§Ù„ØªØ§Ø±ÙŠØ®", "GEO": "Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©", "CIV": "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", "ISLAM": "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©"
    };

    function displayResult() {
        const inputVal = document.getElementById('massarID').value;
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙØ±Ø§ØºØ§Øª ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø­Ø±ÙˆÙ ÙƒØ¨ÙŠØ±Ø©
        const id = inputVal.trim().toUpperCase();
        const out = document.getElementById('output');
        
        if (!id) {
            out.innerHTML = '<div class="error-msg">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹</div>';
            return;
        }

        const s = window.localDB[id];
        
        if (!s) {
            out.innerHTML = `<div class="error-msg">âŒ Ø§Ù„Ø±Ù‚Ù… <strong>${id}</strong> ØºÙŠØ± Ù…Ø³Ø¬Ù„.<br>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.</div>`;
            return;
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
        let h = `<div class="student-name">${s.n}</div>`;
        h += `<div style="margin-bottom:15px;">Ø§Ù„Ù‚Ø³Ù…: <strong>${s.c}</strong></div>`;
        
        h += '<h3>ğŸ“š Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h3><table class="result-table"><tr><th>Ø§Ù„Ù…ÙƒÙˆÙ†</th><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th></tr>';
        for (let i = 0; i < 14; i++) {
            h += `<tr><td>${desc[labels[i]]}</td><td>${s.g[i] || 0}</td></tr>`;
        }
        h += `<tr class="avg-row"><td>Ø§Ù„Ù…Ø¹Ø¯Ù„</td><td>${s.a}</td></tr></table>`;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ø®Ø±Ù‰
        const socAvg = (( (s.g[14]||0) + (s.g[15]||0) + (s.g[16]||0) ) / 3).toFixed(2);
        h += '<h3>ğŸŒ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</h3><table class="result-table"><tr><td>Ø§Ù„ØªØ§Ø±ÙŠØ®</td><td>${s.g[14]||0}</td></tr><tr><td>Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§</td><td>${s.g[15]||0}</td></tr><tr><td>Ø§Ù„Ù…Ø¯Ù†ÙŠØ©</td><td>${s.g[16]||0}</td></tr><tr class="avg-row"><td>Ø§Ù„Ù…Ø¹Ø¯Ù„</td><td>${socAvg}</td></tr></table>';
        
        h += '<h3>ğŸ•Œ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</h3><table class="result-table"><tr><td>Ø§Ù„Ù†Ù‚Ø·Ø©</td><td>${s.g[17]||0}</td></tr></table>';

        out.innerHTML = h;
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        const status = document.getElementById('updateStatus');
        if (!file) return;

        status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
        
        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¹Ù†Ø¯ ÙƒÙ„ Ø±ÙØ¹ Ø¬Ø¯ÙŠØ¯
            window.localDB = {};

            for (let i = 1; i < json.length; i++) {
                const row = json[i];
                if (!row[0]) continue;

                // ØªÙ†Ø¸ÙŠÙ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø« (Ø±Ù‚Ù… Ù…Ø³Ø§Ø±) Ù…Ù† Ø£ÙŠ ÙØ±Ø§ØºØ§Øª Ù…Ø®ÙÙŠØ©
                const massar = String(row[0]).replace(/\s/g, '').toUpperCase();
                
                const grades = [];
                for (let j = 3; j < 21; j++) {
                    grades.push(parseFloat(row[j]) || 0);
                }

                const arabicAvg = (grades.slice(0, 14).reduce((a, b) => a + b, 0) / 14).toFixed(2);

                window.localDB[massar] = {
                    n: row[1], // Ø§Ù„Ø§Ø³Ù…
                    c: row[2], // Ø§Ù„Ù‚Ø³Ù…
                    g: grades, // Ø§Ù„Ù†Ù‚Ø·
                    a: arabicAvg // Ø§Ù„Ù…Ø¹Ø¯Ù„
                };
            }

            const count = Object.keys(window.localDB).length;
            status.innerHTML = `<span style="color:green">âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ù…ÙŠÙ„ ${count} ØªÙ„Ù…ÙŠØ°.</span>`;
            event.target.value = ''; // Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù…Ø¬Ø¯Ø¯Ø§Ù‹

        } catch (e) {
            status.innerHTML = `<span style="color:red">âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ${e.message}</span>`;
        }
    }
</script>
</body>
</html>
