<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØªØ§Ø¦Ø¬ Ù…Ø¯Ø±Ø³Ø© Ø·Ù‡ Ø­Ø³ÙŠÙ† - Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù„ÙƒØ§Ù†ÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --success: #27ae60; --bg: #f4f7f6; --error: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: white; max-width: 800px; margin: 20px auto; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .header { border-bottom: 3px solid var(--accent); margin-bottom: 20px; padding-bottom: 10px; }
        input[type="text"] { padding: 15px; width: 85%; border: 2px solid #ddd; border-radius: 12px; font-size: 1.2em; text-align: center; margin-bottom: 15px; outline: none; }
        input[type="text"]:focus { border-color: var(--accent); }
        button { background: var(--accent); color: white; border: none; padding: 15px 30px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 90%; font-size: 1.1em; transition: 0.3s; margin: 5px 0; }
        button:hover { background: #1f5f8b; transform: translateY(-2px); }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        .result-table th, .result-table td { border: 1px solid #eee; padding: 10px; text-align: center; }
        .result-table th { background: var(--primary); color: white; }
        .student-name { color: #e67e22; font-size: 1.8em; font-weight: bold; margin: 15px 0; }
        .avg-row { background: #fff3cd; font-weight: bold; font-size: 1.2em; }
        .info-panel { background: #e8f4f8; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: right; line-height: 1.6; }
        .error-msg { color: var(--error); padding: 20px; background: #fdedec; border-radius: 10px; margin-top: 20px; font-weight: bold; }
        .admin-panel { margin-top: 30px; padding: 20px; border: 2px dashed #ccc; border-radius: 15px; background: #fafafa; }
        #updateStatus { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h2>
        <p>Ù…Ø¯Ø±Ø³Ø© Ø·Ù‡ Ø­Ø³ÙŠÙ† | Ø§Ù„Ø£Ø³ØªØ§Ø°: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ Ø¨Ù„ÙƒØ§Ù†ÙŠ</p>
    </div>

    <input type="text" id="massarID" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø³Ø§Ø± (Ù…Ø«Ø§Ù„: G123456789)">
    <button onclick="displayResult()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø· Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</button>

    <div id="output"></div>

    <div class="admin-panel">
        <h3 style="color: var(--error);">âš™ï¸ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
        <button style="background: var(--success);" onclick="document.getElementById('excelFile').click()">
            ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø§Ù„Ø¬Ø¯ÙŠØ¯
        </button>
        <div id="updateStatus"></div>
    </div>
</div>

<script>
    const labels = ["PO2", "V1", "V2", "CO1", "CO2", "LF2", "LC1", "LC2", "LC3", "LC4", "PE1", "PE2", "OL1", "OL2", "HIST", "GEO", "CIV", "ISLAM"];
    const desc = {
        "PO2": "Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø´ÙÙ‡ÙŠ", "V1": "Ø§Ù„Ù…Ø¹Ø¬Ù… 1", "V2": "Ø§Ù„Ù…Ø¹Ø¬Ù… 2", "CO1": "ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ 1", "CO2": "ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ 2",
        "LF2": "Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©", "LC1": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 1", "LC2": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 2", "LC3": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 3", "LC4": "ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ 4",
        "PE1": "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ 1", "PE2": "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ 2", "OL1": "Ø§Ù„Ø¸ÙˆØ§Ù‡Ø± Ø§Ù„Ù„ØºÙˆÙŠØ© 1", "OL2": "Ø§Ù„Ø¸ÙˆØ§Ù‡Ø± Ø§Ù„Ù„ØºÙˆÙŠØ© 2",
        "HIST": "Ø§Ù„ØªØ§Ø±ÙŠØ®", "GEO": "Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©", "CIV": "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", "ISLAM": "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©"
    };

    // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù)
    let DB = {};

    function displayResult() {
        const id = document.getElementById('massarID').value.trim().toUpperCase();
        const out = document.getElementById('output');
        
        if (!id) {
            out.innerHTML = '<div class="error-msg">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹</div>';
            return;
        }

        const s = DB[id];
        if (!s) {
            out.innerHTML = `<div class="error-msg">âŒ Ø§Ù„Ø±Ù‚Ù… ${id} ØºÙŠØ± Ù…Ø³Ø¬Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù….</div>`;
            return;
        }

        let h = `<div class="student-name">${s.n}</div>`;
        h += `<div style="margin-bottom:10px;">Ø§Ù„Ù‚Ø³Ù…: <strong>${s.c}</strong></div>`;
        
        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        h += '<h3>ğŸ“š ÙˆØ­Ø¯Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h3>';
        h += '<table class="result-table"><tr><th>Ø§Ù„Ù…ÙƒÙˆÙ†</th><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th></tr>';
        for (let i = 0; i < 14; i++) {
            h += `<tr><td>${desc[labels[i]]}</td><td>${s.g[i] || 0}</td></tr>`;
        }
        h += `<tr class="avg-row"><td>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨</td><td>${s.a}</td></tr></table>`;

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª
        const socAvg = (( (s.g[14]||0) + (s.g[15]||0) + (s.g[16]||0) ) / 3).toFixed(2);
        h += '<h3>ğŸŒ ÙˆØ­Ø¯Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</h3>';
        h += '<table class="result-table"><tr><th>Ø§Ù„Ù…ÙƒÙˆÙ†</th><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th></tr>';
        h += `<tr><td>Ø§Ù„ØªØ§Ø±ÙŠØ®</td><td>${s.g[14] || 0}</td></tr>`;
        h += `<tr><td>Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©</td><td>${s.g[15] || 0}</td></tr>`;
        h += `<tr><td>Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©</td><td>${s.g[16] || 0}</td></tr>`;
        h += `<tr class="avg-row"><td>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©</td><td>${socAvg}</td></tr></table>`;

        // Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
        h += '<h3>ğŸ•Œ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</h3>';
        h += `<table class="result-table"><tr><td>Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</td><td>${s.g[17] || 0}</td></tr></table>`;

        out.innerHTML = h;
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        const status = document.getElementById('updateStatus');
        if (!file) return;

        status.innerHTML = '<span style="color:blue">â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...</span>';

        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (jsonData.length < 2) throw new Error("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº");

            // ØªÙØ±ÙŠØº Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ù†Ø¸ÙŠÙ
            DB = {}; 

            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[0]) continue;

                const massarID = String(row[0]).trim().toUpperCase();
                const grades = [];
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ 18 Ù†Ù‚Ø·Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ 4 Ø¥Ù„Ù‰ 21 (Index 3 to 20)
                for (let j = 3; j < 21; j++) {
                    grades.push(parseFloat(row[j]) || 0);
                }

                const arabicSum = grades.slice(0, 14).reduce((a, b) => a + b, 0);
                const arabicAvg = (arabicSum / 14).toFixed(2);

                DB[massarID] = {
                    n: row[1], // Ø§Ù„Ø§Ø³Ù…
                    c: row[2], // Ø§Ù„Ù‚Ø³Ù…
                    g: grades, // Ø§Ù„Ù…ØµÙÙˆÙØ©
                    a: arabicAvg // Ø§Ù„Ù…Ø¹Ø¯Ù„
                };
            }

            status.innerHTML = `<span style="color:green">âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ù…ÙŠÙ„ ${Object.keys(DB).length} ØªÙ„Ù…ÙŠØ°.</span>`;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ù…ÙƒØªÙˆØ¨ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø©
            if(document.getElementById('massarID').value) displayResult();

        } catch (error) {
            console.error(error);
            status.innerHTML = '<span style="color:red">âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ù…Ù„Ù Excel.</span>';
        }
    }
</script>
</body>
</html>
