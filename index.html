<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نتائج مدرسة طه حسين - الأستاذ بلكاني</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; text-align: center; }
        .card { background: white; max-width: 800px; margin: auto; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        input[type="text"] { padding: 12px; width: 70%; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #eee; padding: 10px; }
        .result-table th { background: var(--primary); color: white; }
        .admin-panel { margin-top: 30px; padding: 20px; border-top: 2px dashed #ccc; display: none; background: #fdf2f2; }
    </style>
</head>
<body>

<div class="card">
    <h2>نتائج مدرسة طه حسين</h2>
    <p>الأستاذ: بلكاني</p>
    <input type="text" id="massarID" placeholder="أدخل رقم مسار">
    <button onclick="displayResult()">عرض النتيجة</button>
    <div id="output"></div>
    <div style="margin-top:50px; cursor:pointer; color:#eee" onclick="document.getElementById('adminPanel').style.display='block'">.</div>

    <div class="admin-panel" id="adminPanel">
        <h3>لوحة التحكم</h3>
        <input type="file" id="excelFile" accept=".xlsx" onchange="handleFileUpload(event)">
        <br><br>
        <button onclick="generateNewHTML()" style="background:#27ae60">حفظ الملف بالترتيب المطلوب</button>
    </div>
</div>

<script id="dbSource">
// الترتيب المطلوب: n ثم c ثم g ثم a
let DB = {
    "G183107408": { n: "الدرقاوي عز العرب", c: "6APG-1", g: [2,0,0,0,2,4,2.5,6,0,0,4.5,1,3,0.25,0,2,2,7.5], a: "1.80" }
};
</script>

<script>
    const labels = ["PO2", "V1", "V2", "CO1", "CO2", "LF2", "LC1", "LC2", "LC3", "LC4", "PE1", "PE2", "OL1", "OL2", "HIST", "GEO", "CIV", "ISLAM"];
    const desc = { "PO2": "التواصل الشفهي", "V1": "المعجم 1", "V2": "المعجم 2", "CO1": "فهم المسموع 1", "CO2": "فهم المسموع 2", "LF2": "طلاقة القراءة", "LC1": "فهم المقروء 1", "LC2": "فهم المقروء 2", "LC3": "فهم المقروء 3", "LC4": "فهم المقروء 4", "PE1": "الإنتاج الكتابي 1", "PE2": "الإنتاج الكتابي 2", "OL1": "الظواهر اللغوية 1", "OL2": "الظواهر اللغوية 2", "HIST": "التاريخ", "GEO": "الجغرافية", "CIV": "التربية المدنية", "ISLAM": "التربية الإسلامية" };

    function displayResult() {
        const id = document.getElementById('massarID').value.trim().toUpperCase();
        const s = DB[id];
        if (!s) { alert("غير موجود"); return; }
        let h = `<h3>${s.n}</h3><table class="result-table">`;
        labels.forEach((l, i) => { h += `<tr><td>${desc[l]}</td><td>${s.g[i]}</td></tr>`; });
        h += `<tr style="background:#eee"><td>المعدل</td><td>${s.a}</td></tr></table>`;
        document.getElementById('output').innerHTML = h;
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        let newDB = {};
        for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row[0]) continue;
            const g = [];
            for (let j = 3; j < 21; j++) g.push(Number(row[j]) || 0);
            const avg = (g.slice(0, 14).reduce((a,b)=>a+b,0)/14).toFixed(2);
            newDB[String(row[0]).trim().toUpperCase()] = { n: row[1], c: row[2], g: g, a: avg };
        }
        DB = newDB;
        alert("تمت المعالجة بنجاح");
    }

    function generateNewHTML() {
        // بناء النص يدوياً كـ "نص خام" لمنع المتصفح من إعادة الترتيب
        let dbString = 'let DB = {\n';
        const keys = Object.keys(DB);
        
        keys.forEach((id, index) => {
            const entry = DB[id];
            const isLast = index === keys.length - 1;
            // بناء السطر يدوياً بالترتيب المطلوب تماماً
            dbString += `        "${id}": { n: "${entry.n}", c: "${entry.c}", g: [${entry.g.join(', ')}], a: "${entry.a}" }${isLast ? '' : ','}\n`;
        });
        dbString += '    };';

        const currentHTML = document.documentElement.outerHTML;
        // استبدال كود الـ DB القديم بالنص الجديد
        const finalHTML = currentHTML.replace(/let DB = \{[\s\S]*?\};/, dbString);

        const blob = new Blob([finalHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'school_results_fixed.html';
        a.click();
    }
</script>
</body>
</html>
